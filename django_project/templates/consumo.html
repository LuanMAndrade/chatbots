{% extends "base.html" %}
{% load static %}

{% block title %}Consumo de Tokens{% endblock %}

{% block page_title %}Consumo de Tokens - {{ selected_project }}{% endblock %}

{% block content %}
<style>
    /* Estilos adaptados de App.css */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .dashboard-header h2 { margin: 0; font-size: 1.5rem; }
    .selectors { display: flex; gap: 20px; }
    .selector select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border-left: 4px solid #3498db; position: relative; }
    .metric-card h3 { font-size: 0.9rem; color: #666; margin-bottom: 8px; text-transform: uppercase; }
    .metric-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }
    .metric-subtitle { font-size: 0.85rem; color: #7f8c8d; margin-top: 8px; }
    
    /* Barra de progresso para porcentagem */
    .progress-bar-container { 
        width: 100%; 
        height: 8px; 
        background: #ecf0f1; 
        border-radius: 4px; 
        margin-top: 12px; 
        overflow: hidden;
    }
    .progress-bar-fill { 
        height: 100%; 
        background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c); 
        border-radius: 4px; 
        transition: width 0.5s ease;
    }
    .progress-bar-fill.full {
        background: #e74c3c;
    }
    
    .charts-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
    .chart-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .error-box { background-color: #f8d7da; color: #721c24; padding: 15px; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 20px; }
    
    /* Badge de status */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 8px;
    }
    .status-badge.safe { background: #d4edda; color: #155724; }
    .status-badge.warning { background: #fff3cd; color: #856404; }
    .status-badge.danger { background: #f8d7da; color: #721c24; }
</style>

<div class="dashboard-header">
    <h2>ðŸ“ˆ Consumo de Tokens - {{ selected_project }}</h2>
    <form method="get" id="filter-form" class="selectors">
        <div class="selector" style="display:none">
            <label for="project">Projeto: </label>
            <select name="project" id="project-select" onchange="document.getElementById('filter-form').submit()">
                {% for project in projects %}
                    <option value="{{ project }}" {% if project == selected_project %}selected{% endif %}>{{ project }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="selector">
            <label for="month">MÃªs: </label>
            <select name="month" id="month-select" onchange="document.getElementById('filter-form').submit()">
                {% for month in available_months %}
                    <option value="{{ month.value }}" {% if month.value == selected_month %}selected{% endif %}>{{ month.label }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{% if error %}
    <div class="error-box">
        <strong>Erro:</strong> {{ error }}
    </div>
{% else %}
    <div class="metrics-grid">
        <!-- Tokens Totais -->
        <div class="metric-card" style="border-left-color: #3498db;">
            <h3>Tokens Totais</h3>
            <p class="metric-value">{{ usage_data.total_tokens|floatformat:0 }}</p>
            <small class="metric-subtitle">de {{ usage_data.tokens_incluidos|floatformat:0 }} incluÃ­dos</small>
        </div>
        
        <!-- Porcentagem de Consumo -->
        <div class="metric-card" style="border-left-color: {% if usage_data.porcentagem_consumo < 70 %}#27ae60{% elif usage_data.porcentagem_consumo < 90 %}#f39c12{% else %}#e74c3c{% endif %};">
            <h3>Porcentagem de Consumo</h3>
            <p class="metric-value">{{ usage_data.porcentagem_consumo|floatformat:1 }}%</p>
            <div class="progress-bar-container">
                <div class="progress-bar-fill {% if usage_data.porcentagem_consumo >= 100 %}full{% endif %}" 
                     style="width: {{ usage_data.porcentagem_consumo }}%;"></div>
            </div>
            {% if usage_data.porcentagem_consumo < 70 %}
                <span class="status-badge safe">âœ“ Consumo Normal</span>
            {% elif usage_data.porcentagem_consumo < 100 %}
                <span class="status-badge warning">âš  Limite PrÃ³ximo</span>
            {% else %}
                <span class="status-badge danger">âš  Limite Atingido</span>
            {% endif %}
        </div>
        
        <!-- Mensagens Enviadas -->
        <div class="metric-card" style="border-left-color: #9b59b6;">
            <h3>Mensagens Enviadas</h3>
            <p class="metric-value">{{ usage_data.run_count }}</p>
            <small class="metric-subtitle">execuÃ§Ãµes no perÃ­odo</small>
        </div>
        
        <!-- Custo Total -->
        <div class="metric-card" style="border-left-color: {% if usage_data.total_cost > 0 %}#e74c3c{% else %}#27ae60{% endif %};">
            <h3>Custo Extra (BRL)</h3>
            <p class="metric-value">R${{ usage_data.total_cost|floatformat:2 }}</p>
            {% if usage_data.total_cost == 0 %}
                <small class="metric-subtitle">âœ“ Sem custos extras</small>
            {% else %}
                <small class="metric-subtitle">âš  Tokens excedentes</small>
            {% endif %}
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-section">
            <h3>ðŸ“Š Uso DiÃ¡rio de Tokens</h3>
            <canvas id="dailyTokensChart"></canvas>
        </div>
        <div class="chart-section">
            <h3>ðŸ’µ Custo DiÃ¡rio (BRL)</h3>
            <canvas id="dailyCostChart"></canvas>
        </div>
    </div>
{% endif %}

{{ daily_data|json_script:"daily-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dailyData = JSON.parse(document.getElementById('daily-data').textContent);

        const labels = dailyData.map(d => new Date(d.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));

        // GrÃ¡fico de Uso de Tokens
        const tokensCtx = document.getElementById('dailyTokensChart');
        if (tokensCtx) {
            new Chart(tokensCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total de Tokens',
                            data: dailyData.map(d => d.total_tokens),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Tokens de Entrada',
                            data: dailyData.map(d => d.input_tokens),
                            borderColor: '#2ecc71',
                            tension: 0.4
                        },
                        {
                            label: 'Tokens de SaÃ­da',
                            data: dailyData.map(d => d.output_tokens),
                            borderColor: '#f39c12',
                            tension: 0.4
                        }
                    ]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // GrÃ¡fico de Custo DiÃ¡rio
        const costCtx = document.getElementById('dailyCostChart');
        if (costCtx) {
            new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Custo Extra (BRL)',
                        data: dailyData.map(d => d.cost),
                        backgroundColor: dailyData.map(d => d.cost > 0 ? '#e74c3c' : '#27ae60'),
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}