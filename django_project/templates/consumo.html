{% extends "base.html" %}
{% load static %}

{% block title %}Consumo de Tokens{% endblock %}

{% block page_title %}Consumo de Tokens - {{ selected_project }}{% endblock %}

{% block content %}
<style>
    /* Estilos adaptados de App.css */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .dashboard-header h2 { margin: 0; font-size: 1.5rem; }
    .selectors { display: flex; gap: 20px; }
    .selector select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border-left: 4px solid #3498db; }
    .metric-card h3 { font-size: 0.9rem; color: #666; margin-bottom: 8px; text-transform: uppercase; }
    .metric-value { font-size: 2rem; font-weight: 700; color: #2c3e50; }
    .charts-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
    .chart-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .error-box { background-color: #f8d7da; color: #721c24; padding: 15px; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 20px; }
</style>

<div class="dashboard-header">
    <h2>ðŸ“ˆ Consumo de Tokens - {{ selected_project }}</h2>
    <form method="get" id="filter-form" class="selectors">
        <div class="selector" style="display:none">
            <label for="project">Projeto: </label>
            <select name="project" id="project-select" onchange="document.getElementById('filter-form').submit()">
                {% for project in projects %}
                    <option value="{{ project }}" {% if project == selected_project %}selected{% endif %}>{{ project }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="selector">
            <label for="month">MÃªs: </label>
            <select name="month" id="month-select" onchange="document.getElementById('filter-form').submit()">
                {% for month in available_months %}
                    <option value="{{ month.value }}" {% if month.value == selected_month %}selected{% endif %}>{{ month.label }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{% if error %}
    <div class="error-box">
        <strong>Erro:</strong> {{ error }}
    </div>
{% else %}
    <div class="metrics-grid">
        <div class="metric-card" style="border-left-color: #3498db;">
            <h3>Tokens Totais</h3>
            <p class="metric-value">{{ usage_data.total_tokens|floatformat:0 }}</p>
            <small>{{ usage_data.run_count }} execuÃ§Ãµes</small>
        </div>
        <div class="metric-card" style="border-left-color: #2ecc71;">
            <h3>Tokens de Entrada</h3>
            <p class="metric-value">{{ usage_data.input_tokens|floatformat:0 }}</p>
        </div>
        <div class="metric-card" style="border-left-color: #f39c12;">
            <h3>Tokens de SaÃ­da</h3>
            <p class="metric-value">{{ usage_data.output_tokens|floatformat:0 }}</p>
        </div>
        <div class="metric-card" style="border-left-color: #e74c3c;">
            <h3>Custo Total (BRL)</h3>
            <p class="metric-value">R${{ usage_data.total_cost|floatformat:2 }}</p>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-section">
            <h3>ðŸ“Š Uso DiÃ¡rio de Tokens</h3>
            <canvas id="dailyTokensChart"></canvas>
        </div>
        <div class="chart-section">
            <h3>ðŸ’µ Custo DiÃ¡rio (BRL)</h3>
            <canvas id="dailyCostChart"></canvas>
        </div>
    </div>
{% endif %}

{{ daily_data|json_script:"daily-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dailyData = JSON.parse(document.getElementById('daily-data').textContent);

        const labels = dailyData.map(d => new Date(d.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));

        // GrÃ¡fico de Uso de Tokens
        const tokensCtx = document.getElementById('dailyTokensChart');
        if (tokensCtx) {
            new Chart(tokensCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total de Tokens',
                            data: dailyData.map(d => d.total_tokens),
                            borderColor: '#3498db',
                            tension: 0.1
                        },
                        {
                            label: 'Tokens de Entrada',
                            data: dailyData.map(d => d.input_tokens),
                            borderColor: '#2ecc71',
                            tension: 0.1
                        },
                        {
                            label: 'Tokens de SaÃ­da',
                            data: dailyData.map(d => d.output_tokens),
                            borderColor: '#f39c12',
                            tension: 0.1
                        }
                    ]
                },
                options: { responsive: true }
            });
        }

        // GrÃ¡fico de Custo DiÃ¡rio
        const costCtx = document.getElementById('dailyCostChart');
        if (costCtx) {
            new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Custo (BRL)',
                        data: dailyData.map(d => d.cost),
                        backgroundColor: '#e74c3c',
                    }]
                },
                options: { responsive: true }
            });
        }
    });
</script>
{% endblock %}